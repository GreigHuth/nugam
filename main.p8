pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--Made By Gurg
-- i want it to be made clear that i never said i was actually good at programming


--GLOBAL TABLES
TILE_FLAG = {
    FOREGROUND = 0,
    SOLID = 1,
    SLOPE = 2,
    SCANNABLE = 6
}

actors_d = {}

--heightmap for tiles, index corresponds to sprite number
heightmap = {}
heightmap[64] = {8,8,8,8,8,8,8,8}
heightmap[65] = {1,2,3,4,5,6,7,8}
heightmap[66] = {8,7,6,5,4,3,2,1}
heightmap[67] = {1,1,2,2,3,3,4,4}
heightmap[68] = {4,4,3,3,2,2,1,1}
heightmap[69] = {2,4,6,8,8,8,8,8}
heightmap[70] = {8,8,8,8,8,6,4,2}
heightmap[71] = {1,1,1,2,2,2,3,3}
heightmap[72] = {3,4,4,4,5,5,5,5}
heightmap[73] = {5,5,5,5,4,4,4,3}
heightmap[74] = {3,3,2,2,2,1,1,1}
heightmap[83] = {5,5,6,6,7,7,8,8}
heightmap[84] = {8,8,7,7,6,6,5,5}
heightmap[85] = {0,0,0,0,5,6,7,8}
heightmap[86] = {8,7,6,5,0,0,0,0}

COLOR = {
    BLACK = 0, 
    DARK_BLUE = 1,
    LIGHT_BLUE = 2,
    DARK_GREEN = 3,
    VERY_DARK_BLUE = 4

}

    
actors_d = {} --list of actors to be drawn

actors_u = {} --list of actors to only be updated

global_timer = 0

--ordered by dependency
#include includes/math.lua
#include includes/actors.lua
#include includes/player.p8
#include includes/camera.lua
#include includes/enemies.p8

#include includes/effects.lua
#include includes/gun.lua
#include includes/scan.lua


function mkb_init(enable, btn_emu, ptr_lock)
    -- pass args as bitfield into hardware register
    poke(0x5f2d,(enable   and 1 or 0)
               |(btn_emu  and 2 or 0)
               |(ptr_lock and 4 or 0))
end


function _init()


    --globals
    game_over = false
    debug_on = true
    grid_x = 0
    grid_y = 0 --current grid position
    map_tile = 0
    flag_tile = 0
    hitboxes_on = false
    frame_counter = 0
    gravity = 0.1 ---gravity in pixels per frame per frame


    --initialise player
    player:init()

    --snow_setup()
    
    mkb_init(true, false, false)
    
    add(actors_d, player) -- player is always drawn so set that first #
    add(actors_u, player)
    
    --add(actors_d, boss1)
    --add(actors_u, boss1)
    
    add(actors_u, scan_rect)
end




--prints debug information to screen
function debug()
    
    dmesg = {} --need to reinitialise every frame
    test = 0
    add(dmesg, player.dx)
    add(dmesg, player.dy)
    add(dmesg, player:hit_wall())
    add(dmesg, stat(34))
    
    
    local line = 0
    local camx, camy = get_camera_pos()
    for mesg in all(dmesg) do
        color(8)
        print (mesg, 5+camx, line+camy )
        line += 6
    end
end

function mouse_left_press()
    return stat(34) == 1
end

function mouse_right_press()
    return stat(34) == 2
end

function mouse_middle_press()
    return stat(34) == 4
end

--where you update the game logic can be 30 or 60
function _update60()
    frame_counter = (frame_counter+1)%stat(8)
    global_timer += 1
    foreach(actors_u, function(obj) obj:update() end)
end 


function _draw()
    cls()
    local celwh = 120 
    map(0,0, 0, 0, celwh,celwh) --draws background objects

    update_camera() 

    foreach(actors_d, function(obj) obj:draw() end)--draw actors

    map(0,0, 0,0, celwh,celwh, 1) --draws foreground objects
   
    if player.flags.scanning == true then 
        scan_rect:draw()
    else --not scanning ie default

        --draw cursor
        local cursor_x = stat(32)+camera_pos.x
        local cursor_y = stat(33)+camera_pos.y
        circ(cursor_x, cursor_y, 0, 7)

        --draw active bullets
        foreach(bullets, bullet_update_and_draw)
    end

    

    if debug_on then
        debug()
    end

    player:drawHUD()

    if hitboxes_on then 
        foreach(actors_d, function(obj) obj:draw_hitbox() end)
    end
end 

 
__gfx__
00000000006666000066660000000000006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005a5a00005a5a0000666600005a5a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000055550000555500005a5a00005555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000006666000066660000555500006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000666600006666000066660005666650000666000bbbbbb00bbbbbb00bbbbbb000000000000000000000000000000000000000000000000000000000
007007000050050005000050006666000098800000655a00bbcbbbcbbbcbbbcbbbcbbbcb0bbbbbb0000000000000000000000000000000000000000000000000
000000000000000000000000000000000aa9900050a55500bbbbbbbbbbb888bbbbbbbbbbbbcbbbcbbbcbbbcb0000000000000000000000000000000000000000
00000000000000000000000000000000a000a000056666500bb888b00bb888b00bbbbbb0bbbbbbbbbbbbbbbb0000000000000000000000000000000000000000
00000000000000000066660000666600000666600066660000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000005a5a0000555500006555500055556000000000000000000000000000000000000000000000000000000000000000000000000000000000
00a00a000000000000555500005a5a000005a5a000a5a50000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000006666000066660000666600000a66a000a66a0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005a5a000066665000666600006666600066666000000000000000000000000000000000000000000000000000000000000000000000000000000000
00a00a00006666000500000005000050006550050500556000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000006500000000056000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000650000000560000000000000000000000000000000000000000000000000000000000000000000000000000000000
000600008006600000000000007bb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00656000506666000058850000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06656600556116600500005000666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666666600617716000000000005bb500006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
060006000617116000000000005bb500005995000000000000000000000000000000000000000000000000000006666666666000000000000000000000000000
080008000661166000000000006bb600006996000000000000000000000000000000000000000000000000000006666666666000000000000000000000000000
00000000556666550000000000666600006666000000000000000000000000000000000000000000000000000000066666600000000000000000000000000000
00000000500550050566665005000050050000500000000000000000000000000000000000000000000000000000006666000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666000000000000000000000000000000
00000000000000000000000000000000000000000000000000044400000000000000000000000000000000000000006666000000000000000000000000000000
00000000000000000000000000000000000000000000000000558800000000000000000000000000000000000000006666000000000000000000000000000000
00000000000000000000000000000000000000000000000000544500000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000045400000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000460400000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000005000050000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000005000050000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000011000000000000000000000000001111111111000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000111100000000000000000000000001111111111000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000001111110000000000000000000000011111111111100000000000000000000000000000000000000000000000000000000000000000000000000
11111111000011111111000000000000000000000011111111111100000000000000111111110000000000000000000000000000000000000000000000000000
11111111000111111111100000000011110000000111111111111110000000000111111111111110000000000000000000000000000000000000000000000000
11111111001111111111110000001111111100000111111111111110000000111111111111111111110000000000000000000000000000000000000000000000
11111111011111111111111000111111111111001111111111111111000111111111111111111111111110000000000000000000000000000000000000000000
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000
01111111111111110000000000000011110000000000000110000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111100000000000001111111100000000001111000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111000000000000111111111111000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111110000000000011111111111111110000111111110000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111100000000000011111111111111110000111111110000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111000000000000011111111111111110000111111110000000000000000000000000000000000000000000000000000000000000000000000000000
11111111110000000000000011111111111111110000111111110000000000000000000000000000000000000000000000000000000000000000000000000000
11111111100000000000000011111111111111110000111111110000000000000000000000000000000000000000000000000000000000000000000000000000
11111110111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111001111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074002600000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000007474000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0040c0c0c0400000000000000000000040c0c0c0c0c000000000000000000000004040000000000000000000000000000000000000000000000000000000000002040404040404040404040000000000024040040404044040400000000000000240404040404040400040000000000040404040404040404040400000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000445874000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4000000000004040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000540000000000000000000000000075000000000000000000000000000000000000000000000046464646464644444444444444444444
4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000590072000000000000000000000000000000000046460000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404000000000000000000000000000000000000000007400000000000000000000000000000000000000000000000000000072000000000000000000000000000000004600000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404000000000000000000000000000000000000000740000000000000054000000000000000000000000000000000000000072000000750000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040004040404040404040404040404040404040404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002100000000000000000000000000000000000000000000
0000004040404040404040404040404040404040404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000004040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000004040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00040000000000000000000000000c0500e0501005011050130501505017050180500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
02 00424344
00 01424344

